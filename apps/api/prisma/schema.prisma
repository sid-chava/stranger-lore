generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum FolderKind {
  canon
  theory
}

model User {
  id        String   @id @default(uuid())
  stackAuthId String @unique @map("stack_auth_id") // Maps to Stack Auth user ID
  email     String?
  name      String?
  username  String?  @unique
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  userRoles UserRole[]
  createdAtPages Page[] @relation("PageCreator")
  createdTheories Theory[]
  moderatedTheories Theory[] @relation("TheoryModerator")
  votes Vote[]
  contributions Contribution[]

  @@map("users")
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  userRoles UserRole[]

  @@map("roles")
}

model UserRole {
  id     String @id @default(uuid())
  userId String @map("user_id")
  roleId String @map("role_id")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([userId, roleId])
  @@map("user_roles")
}

model Folder {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  parentId    String?  @map("parent_id")
  description String?
  sortOrder   Int      @default(0) @map("sort_order")
  isFeatured  Boolean  @default(false) @map("is_featured")
  kind        FolderKind @default(canon)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  parent   Folder?   @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children Folder[]  @relation("FolderHierarchy")
  pages    Page[]
  navigationConfig NavigationConfig?

  @@index([parentId])
  @@index([slug])
  @@map("folders")
}

model Page {
  id          String   @id @default(uuid())
  folderId    String   @map("folder_id")
  title       String
  slug        String
  status      String   @default("draft") // draft, published, archived
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdById String?  @map("created_by_id")

  createdBy User?         @relation("PageCreator", fields: [createdById], references: [id])
  folder   Folder        @relation(fields: [folderId], references: [id])
  revisions PageRevision[]

  @@unique([folderId, slug])
  @@index([folderId])
  @@index([slug])
  @@index([status])
  @@map("pages")
}

model PageRevision {
  id        String   @id @default(uuid())
  pageId    String   @map("page_id")
  content   String   // Markdown or JSON content
  version   Int      @default(1)
  createdAt DateTime @default(now()) @map("created_at")
  createdBy String?  @map("created_by") // User ID who made this revision

  page Page @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@index([pageId])
  @@index([pageId, version])
  @@map("page_revisions")
}

model NavigationConfig {
  id        String   @id @default(uuid())
  folderId  String   @unique @map("folder_id")
  sortOrder Int      @map("sort_order")
  isVisible Boolean  @default(true) @map("is_visible")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  folder Folder @relation(fields: [folderId], references: [id], onDelete: Cascade)

  @@index([sortOrder])
  @@map("navigation_config")
}

model Theory {
  id          String   @id @default(uuid())
  title       String?
  content     String   // The theory text submitted by user
  status      String   @default("pending") // pending, approved, denied
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdById String   @map("created_by_id")
  moderatedById String? @map("moderated_by_id") // Admin who approved/denied
  moderatedAt DateTime? @map("moderated_at")
  denialReason String? @map("denial_reason")

  createdBy User? @relation(fields: [createdById], references: [id], onDelete: Cascade)
  moderator User? @relation("TheoryModerator", fields: [moderatedById], references: [id])
  tags      TheoryTag[]
  votes     Vote[]
  contributions Contribution[]

  @@index([status])
  @@index([createdAt])
  @@index([createdById])
  @@map("theories")
}

model Tag {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now()) @map("created_at")

  theories TheoryTag[]

  @@index([name])
  @@map("tags")
}

model TheoryTag {
  id       String @id @default(uuid())
  theoryId String @map("theory_id")
  tagId    String @map("tag_id")

  theory Theory @relation(fields: [theoryId], references: [id], onDelete: Cascade)
  tag    Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([theoryId, tagId])
  @@index([theoryId])
  @@index([tagId])
  @@map("theory_tags")
}

model Vote {
  id       String   @id @default(uuid())
  theoryId String  @map("theory_id")
  userId   String  @map("user_id")
  value    Int      // 1 for upvote, -1 for downvote
  createdAt DateTime @default(now()) @map("created_at")

  theory Theory @relation(fields: [theoryId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([theoryId, userId])
  @@index([theoryId])
  @@index([userId])
  @@map("votes")
}

enum ContributionType {
  theory_vote
  theory_approved
}

model Contribution {
  id        String           @id @default(uuid())
  userId    String           @map("user_id")
  theoryId  String           @map("theory_id")
  type      ContributionType
  createdAt DateTime         @default(now()) @map("created_at")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  theory Theory @relation(fields: [theoryId], references: [id], onDelete: Cascade)

  @@unique([userId, theoryId, type])
  @@index([userId])
  @@index([type])
  @@map("contributions")
}
